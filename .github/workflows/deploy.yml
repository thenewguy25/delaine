name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: bcmath, ctype, curl, dom, fileinfo, json, mbstring, openssl, pdo, tokenizer, xml

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install Composer dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader --no-dev

      - name: Install NPM dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build

      - name: Create deployment package
        run: |
          echo "üîç Debugging deployment package creation..."
          echo "Current directory: $(pwd)"
          echo "Files in current directory:"
          ls -la

          # Create a clean copy of the project for packaging
          mkdir -p /tmp/delaine-deploy

          echo "üìÅ Created temporary directory: /tmp/delaine-deploy"

          # Copy source files only (excluding build artifacts and unnecessary files)
          rsync -av --exclude='.git' --exclude='node_modules' --exclude='tests' --exclude='.github' --exclude='docker-compose.yml' --exclude='Dockerfile' --exclude='.env.example' --exclude='public/build' --exclude='vendor' . /tmp/delaine-deploy/

          echo "üìã Files copied to temporary directory"

          cd /tmp/delaine-deploy

          echo "üìÇ Changed to temporary directory: $(pwd)"

          # Install production dependencies in the clean copy
          composer install --no-progress --prefer-dist --optimize-autoloader --no-dev
          npm ci

          # Build assets in the clean copy
          npm run build

          # Verify build completed successfully
          if [ ! -f "public/build/manifest.json" ]; then
            echo "‚ùå Build failed - manifest.json not found"
            exit 1
          fi

          echo "‚úÖ Build verification passed"

          # Create the package using zip instead of tar (more reliable)
          echo "üì¶ Creating zip package..."
          zip -r delaine-staging.zip . -x "node_modules/*" ".git/*" "*.log" "*.tmp"

          echo "üì¶ Zip package created successfully"

          # Move package back to workspace
          mv delaine-staging.zip ${{ github.workspace }}/

          echo "‚úÖ Package moved to workspace: ${{ github.workspace }}"

      - name: Deploy to staging server
        run: |
          echo "üöÄ Deploying to staging environment..."
          # Add your staging deployment commands here
          # Example:
          # scp delaine-staging.zip user@staging-server:/var/www/
          # ssh user@staging-server "cd /var/www && unzip -o delaine-staging.zip && php artisan migrate --force && php artisan config:cache"

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -rf /tmp/delaine-deploy
          rm -f delaine-staging.zip

      - name: Run post-deployment tests
        run: |
          echo "üß™ Running post-deployment health checks..."
          # Add health check commands here
          # Example: curl -f https://staging.delaine.com/health

      - name: Notify deployment success
        run: |
          echo "‚úÖ Successfully deployed to staging!"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: bcmath, ctype, curl, dom, fileinfo, json, mbstring, openssl, pdo, tokenizer, xml

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install Composer dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader --no-dev

      - name: Install NPM dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build

      - name: Create deployment package
        run: |
          echo "üîç Debugging deployment package creation..."
          echo "Current directory: $(pwd)"
          echo "Files in current directory:"
          ls -la

          # Create a clean copy of the project for packaging
          mkdir -p /tmp/delaine-deploy-prod

          echo "üìÅ Created temporary directory: /tmp/delaine-deploy-prod"

          # Copy source files only (excluding build artifacts and unnecessary files)
          rsync -av --exclude='.git' --exclude='node_modules' --exclude='tests' --exclude='.github' --exclude='docker-compose.yml' --exclude='Dockerfile' --exclude='.env.example' --exclude='public/build' --exclude='vendor' . /tmp/delaine-deploy-prod/

          echo "üìã Files copied to temporary directory"

          cd /tmp/delaine-deploy-prod

          echo "üìÇ Changed to temporary directory: $(pwd)"

          # Install production dependencies in the clean copy
          composer install --no-progress --prefer-dist --optimize-autoloader --no-dev
          npm ci

          # Build assets in the clean copy
          npm run build

          # Verify build completed successfully
          if [ ! -f "public/build/manifest.json" ]; then
            echo "‚ùå Build failed - manifest.json not found"
            exit 1
          fi

          echo "‚úÖ Build verification passed"

          # Create the package using zip instead of tar (more reliable)
          echo "üì¶ Creating zip package..."
          zip -r delaine-production.zip . -x "node_modules/*" ".git/*" "*.log" "*.tmp"

          echo "üì¶ Zip package created successfully"

          # Move package back to workspace
          mv delaine-production.zip ${{ github.workspace }}/

          echo "‚úÖ Package moved to workspace: ${{ github.workspace }}"

      - name: Create backup
        run: |
          echo "üì¶ Creating backup before deployment..."
          # Add backup commands here
          # Example: ssh user@prod-server "cd /var/www && tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz ."

      - name: Deploy to production server
        run: |
          echo "üöÄ Deploying to production environment..."
          # Add your production deployment commands here
          # Example:
          # scp delaine-production.zip user@prod-server:/var/www/
          # ssh user@prod-server "cd /var/www && unzip -o delaine-production.zip && php artisan migrate --force && php artisan config:cache && php artisan queue:restart"

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -rf /tmp/delaine-deploy-prod
          rm -f delaine-production.zip

      - name: Run post-deployment tests
        run: |
          echo "üß™ Running post-deployment health checks..."
          # Add health check commands here
          # Example: curl -f https://delaine.com/health

      - name: Notify deployment success
        run: |
          echo "‚úÖ Successfully deployed to production!"

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Rollback to previous version
        run: |
          echo "üîÑ Rolling back deployment..."
          # Add rollback commands here
          # Example: ssh user@server "cd /var/www && tar -xzf backup-*.tar.gz"

      - name: Notify rollback
        run: |
          echo "‚ö†Ô∏è Deployment rolled back due to failure"
